
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://robmoore-i.github.io/writing/tutorials/unit-testing-for-jenkins-pipeline-libraries/">
      
      
        <link rel="prev" href="../ukkonens-algorithm-for-mortals/">
      
      
        <link rel="next" href="../../notes/chestertons-traffic-lights/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Unit Testing for Jenkins Pipeline Libraries - Rob's Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#unit-testing-for-jenkins-pipeline-libraries" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Rob&#39;s Wiki" class="md-header__button md-logo" aria-label="Rob's Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rob's Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Unit Testing for Jenkins Pipeline Libraries
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Rob&#39;s Wiki" class="md-nav__button md-logo" aria-label="Rob's Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rob's Wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Work
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reading
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reading
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reading/articles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Articles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reading/books/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Books
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reading/log/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Log
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reading/selected-snippets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Selected snippets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reading/videos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Videos
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Writing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Writing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-experience/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developer Experience
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reader-experience/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reader Experience
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gradle
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Gradle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/insider-guidelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Insider guidelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/intellij-idea/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intellij IDEA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/kotlin-dsl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kotlin DSL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/gradle-monorepo-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gradle monorepo structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/jvms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JVMs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/registering-gradle-tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Registering Gradle tasks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/custom-task-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom task types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/custom-repositories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom repositories
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gradle/secure-dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secure Dependencies
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../documentation/divio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Divio's documentation system
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../documentation/values/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation: Values
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" checked>
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-this-wiki-to-fly-io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migrating this Wiki to fly.io
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukkonens-algorithm-for-mortals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ukkonen's Algorithm for Mortals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Unit Testing for Jenkins Pipeline Libraries
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Unit Testing for Jenkins Pipeline Libraries
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Motivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-challenge-of-writing-automated-tests-for-pipeline-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      The challenge of writing automated tests for pipeline libraries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-costs-of-untested-code-still-apply-to-pipeline-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      The costs of untested code still apply to pipeline libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#put-a-build-tool-around-your-pipeline-library-code" class="md-nav__link">
    <span class="md-ellipsis">
      Put a build tool around your pipeline library code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-3rd-party-interfaces-using-an-adaptor-class" class="md-nav__link">
    <span class="md-ellipsis">
      Wrap 3rd party interfaces using an Adaptor class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#only-write-tests-that-give-you-confidence" class="md-nav__link">
    <span class="md-ellipsis">
      Only write tests that give you confidence
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invest-in-really-understanding-the-ci-agent-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Invest in really understanding the CI agent runtime
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Example of a test
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/chestertons-traffic-lights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chesterton's Traffic Lights
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Motivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-challenge-of-writing-automated-tests-for-pipeline-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      The challenge of writing automated tests for pipeline libraries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-costs-of-untested-code-still-apply-to-pipeline-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      The costs of untested code still apply to pipeline libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#put-a-build-tool-around-your-pipeline-library-code" class="md-nav__link">
    <span class="md-ellipsis">
      Put a build tool around your pipeline library code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-3rd-party-interfaces-using-an-adaptor-class" class="md-nav__link">
    <span class="md-ellipsis">
      Wrap 3rd party interfaces using an Adaptor class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#only-write-tests-that-give-you-confidence" class="md-nav__link">
    <span class="md-ellipsis">
      Only write tests that give you confidence
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invest-in-really-understanding-the-ci-agent-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Invest in really understanding the CI agent runtime
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Example of a test
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="unit-testing-for-jenkins-pipeline-libraries">Unit Testing for Jenkins Pipeline Libraries<a class="headerlink" href="#unit-testing-for-jenkins-pipeline-libraries" title="Permanent link">&para;</a></h1>
<p>This is my guide to writing unit testable Jenkins shared pipeline libraries, which allows you to support greater complexity and agility in your CI system. I first developed this practice in 2020 with the help of my friend Adrian Bärtschi.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Almost everyone now uses automated CI pipelines. Originally they just ran the build, but in contemporary development ecosystems, pipelines have a diverse range of responsibilities, such as:</p>
<ul>
<li>Producing derivative build artifacts, like Docker images</li>
<li>Publishing build artifacts to an artifact repository</li>
<li>Deploying components into various environments</li>
<li>Integrating other verification tools, like static code analysis, performance
  testing and mutation testing</li>
<li>Audit compliance</li>
</ul>
<p>The behaviour of these complex custom pipelines is determined by some kind of pipeline configuration. In this article, I'll use a Jenkins pipeline, with the pipeline definition written using Groovy. There are similar "pipeline-as-code" solutions for other CI servers, such as <a href="https://github.com/gocd-contrib/gomatic">Gomatic</a> for <a href="http://www.gocd.org/">GoCD</a>. TeamCity allows you to define your pipelines using <a href="https://www.jetbrains.com/help/teamcity/kotlin-dsl.html">its Kotlin DSL</a>.</p>
<h3 id="the-challenge-of-writing-automated-tests-for-pipeline-libraries">The challenge of writing automated tests for pipeline libraries<a class="headerlink" href="#the-challenge-of-writing-automated-tests-for-pipeline-libraries" title="Permanent link">&para;</a></h3>
<p>One of the challenges with automated testing for pipeline libraries is that many of the behaviours that you expect from a pipeline don't lend themselves so obviously to unit testing. For example - publishing an artifact in a remote artifact repository.</p>
<p>Additionally, your code may depend heavily on behaviour that is only available when run on a real CI agent. In Jenkins, an obvious example might be invoking shell commands. Invoking shell commands within a replicated environment for a unit test would require some fairly heavyweight setup, although it could be technically feasible.</p>
<h3 id="the-costs-of-untested-code-still-apply-to-pipeline-libraries">The costs of untested code still apply to pipeline libraries<a class="headerlink" href="#the-costs-of-untested-code-still-apply-to-pipeline-libraries" title="Permanent link">&para;</a></h3>
<p>Based on the above challenges faced by pipeline library maintainers, almost all the pipeline library code I've seen exists without having any kind of automated testing. The code is only exercised during manual testing, done on an actual CI agent. The different branches are tested individually, and in general, the cost of change is quite high. If you choose not to accept a high cost of change, then consumers will pay. Bugs can be missed, and pipelines may break even due to minor issues like typos. Code review will not save you from these things.</p>
<p>For changes that have the potential to affect many behaviours of the pipeline library, the manual testing phase will have to cover everything. This will provide a huge barrier to broadly scoped refactorings which would otherwise have the potential to greatly improve your experience of making changes.</p>
<p>A lack of tests will also discourage other developers from making changes to the pipeline library. This will make existing maintainers into bottlenecks, which is an unfortunate position to be in. This compounds with the cost of change, because not only are maintainers in a position where they are in-demand bottlenecks, but also they can't safely make refactorings which could make it possible for non-maintainers to make changes.</p>
<p>This problem of bottleneck maintainers is especially bad for teams where the pipeline library maintainers are "part-time", that is, they are actually meant to be doing feature delivery, but they are also the team's de-facto "CI person". A lack of tests will cement this person's role as full-time pipeline library maintainer by making the code inaccessible to other people, who cannot safely make changes.</p>
<h2 id="put-a-build-tool-around-your-pipeline-library-code">Put a build tool around your pipeline library code<a class="headerlink" href="#put-a-build-tool-around-your-pipeline-library-code" title="Permanent link">&para;</a></h2>
<p>My friend Adrian Bärtschi introduced me to this while we worked together. We used Gradle to define a project layout that enabled us to develop the pipeline library like a normal JVM codebase, including remote dependencies and test sources.</p>
<p>We organise our pipeline library code like this:</p>
<ul>
<li>build.gradle</li>
<li>settings.gradle</li>
<li>src<ul>
<li>some_package<ul>
<li>MyPipeline.groovy</li>
</ul>
</li>
</ul>
</li>
<li>test<ul>
<li>some_package<ul>
<li>MyJunitTest.java</li>
</ul>
</li>
</ul>
</li>
<li>vars<ul>
<li>entryPoint.groovy</li>
</ul>
</li>
</ul>
<p>Our <code>build.gradle</code> looks like this:</p>
<pre><code>plugins {
  id &quot;groovy&quot;
}

repositories {
  mavenCentral()
}

dependencies {
  implementation &quot;org.codehaus.groovy:groovy-all:2.4.15&quot;

  testImplementation &quot;org.junit.jupiter:junit-jupiter:5.4.2&quot;
  testImplementation &quot;org.mockito:mockito-core:3.5.13&quot;
  testImplementation &quot;org.hamcrest:hamcrest:2.2&quot;
  testRuntimeOnly &quot;org.junit.jupiter:junit-jupiter-engine&quot;
}

test {
  useJUnitPlatform()
}

sourceSets {
  main {
    groovy {
      //noinspection GroovyAssignabilityCheck
      srcDirs = [&quot;vars&quot;, &quot;src&quot;]
    }
  }

  test {
    java {
      //noinspection GroovyAssignabilityCheck
      srcDirs = [&quot;test&quot;]
    }
  }
}
</code></pre>
<p>With this setup, you can write you pipeline library as-normal.</p>
<p>Something to note is that we're using Java for the test sources, but Groovy for the main sources. This is because we wanted to Junit for the tests, which is a tool we're really familiar with. In general, Java is also a language we are more familiar with, so we thought we'd rather use that. In practice, it probably doesn't matter much what you go with. Gradle provides an extensible build language, such as the <code>sourceSets</code> construction, which enables you to pick-and-choose based on whatever works best for your team and your context.</p>
<h2 id="wrap-3rd-party-interfaces-using-an-adaptor-class">Wrap 3rd party interfaces using an Adaptor class<a class="headerlink" href="#wrap-3rd-party-interfaces-using-an-adaptor-class" title="Permanent link">&para;</a></h2>
<p>For the interfaces that can only be realistically implemented on a CI agent, define the interface clearly and position it in your code such that you can inject test doubles for that behaviour.</p>
<p>Below is an example of a Jenkins pipeline library class which wraps the CI agent runtime environment in order to provide a testable interface.</p>
<p>The <code>Object jenkins</code> which is injected as a dependency in the constructor is the object which access to all the default methods available within the CI agent runtime environment. In Jenkins, this includes any methods or fields provided by Jenkins plugins and by Jenkins itself.</p>
<pre><code class="language-groovy">// Jenkins.groovy

/**
 * An example of a simple wrapper object which delegates to the object 
 * representing the CI agent runtime environment. This object can be mocked in
 * tests so that all the code in the pipeline library can be exercised locally
 * in unit tests.
 */
class Jenkins {
    private final Object jenkins

    Jenkins(Object jenkins) {
        this.jenkins = jenkins
    }

    void node(Closure closure) {
        jenkins.node(closure)
    }

    void stage(String name, Closure closure) {
        println(&quot;--- Stage: ${name} ---&quot;)
        jenkins.stage(name, closure)
    }

    void println(String text) {
        jenkins.echo(text)
    }

    void sh(String script) {
        jenkins.sh(script)
    }
}
</code></pre>
<h2 id="only-write-tests-that-give-you-confidence">Only write tests that give you confidence<a class="headerlink" href="#only-write-tests-that-give-you-confidence" title="Permanent link">&para;</a></h2>
<p>In a context where almost all the behaviours you want to test are dependent on an external interface, it can be tempting to write tests which use mocks to bake in the current implementation, rather than write tests which verify behaviour that really gives you confidence.</p>
<p>An example of a really simple test that gives me a very basic level of confidence is a test that just exercises all the code and makes sure that there are no typos or dynamic typing mismatches.</p>
<p>A more complicated test might stub Jenkins' <code>findFiles</code> to provide a list of files in the same format as is returned by Jenkins agents' runtime, and then assert that some kind of transformations and filters were happened correctly.</p>
<h2 id="invest-in-really-understanding-the-ci-agent-runtime">Invest in really understanding the CI agent runtime<a class="headerlink" href="#invest-in-really-understanding-the-ci-agent-runtime" title="Permanent link">&para;</a></h2>
<p>One of my favourite things about TDD is that you can't do it well without understanding the problem domain. It will be impossible to write many useful tests for your pipeline library if you don't understand the behaviours that you depend on, because you need to be able to stub the behaviour correctly where appropriate, and you need to know which interactions to write mock object verifications for as assertions.</p>
<p>For this reason, I recommend reading up on the behaviour of the out-of-the-box Jenkins behaviours, and the behaviour of the add-on plugins which your pipeline library depends on. Understanding them well will help you to write a pipeline which works nicely, and where the tests you have for it give you confidence in your changes.</p>
<h2 id="example-of-a-test">Example of a test<a class="headerlink" href="#example-of-a-test" title="Permanent link">&para;</a></h2>
<p>Here's an example of a test from a pipeline library I wrote not too long ago as a personal project, while I was doing more exploration practically in the area of unit testing for pipeline libraries.</p>
<pre><code>package stage.clone;

import org.junit.jupiter.api.Test;
import org.mockito.InOrder;
import org.mockito.Mockito;
import pipeline.JobParameters;
import pipeline.MockJenkins;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.verify;

public class CloneStageTest {

    private final JobParameters jobParameters = new JobParameters(&quot;https://github.com/robmoore-i/AccountingCalisthenics&quot;);

    @Test
    void returnsTheCodeDirectoryRelativePath() {
        MockJenkins jenkins = new MockJenkins();
        CloneStage stage = new CloneStage(jenkins);

        assertEquals(&quot;code&quot;, stage.run(jobParameters));
    }

    @Test
    void ensuresTheCodeDirectoryIsDeletedBeforeCloning() {
        MockJenkins jenkins = new MockJenkins();
        CloneStage stage = new CloneStage(jenkins);

        stage.run(jobParameters);

        InOrder inOrder = Mockito.inOrder(jenkins.mock);
        inOrder.verify(jenkins.mock).sh(&quot;rm -rf code&quot;);
        inOrder.verify(jenkins.mock).sh(startsWith(&quot;git clone&quot;));
    }

    @Test
    void clonesTheGivenRepository() {
        MockJenkins jenkins = new MockJenkins();
        CloneStage stage = new CloneStage(jenkins);

        stage.run(jobParameters);

        verify(jenkins.mock).sh(&quot;git clone &quot; + jobParameters.githubUrl + &quot; code&quot;);
    }

    @Test
    void startsTheStage() {
        MockJenkins jenkins = new MockJenkins();
        CloneStage stage = new CloneStage(jenkins);

        stage.run(jobParameters);

        verify(jenkins.mock).stage(eq(&quot;Clone&quot;), any());
    }
}
</code></pre>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Writing automated tests for pipeline libraries can be challenging</p>
</li>
<li>
<p>Growing your pipeline library code without tests will result in the same
  problems as you would see from any other codebase that is growing without
  tests.</p>
</li>
<li>
<p>There are a few techniques you can apply which will make writing tests for
  your pipeline library easier, such as:</p>
<ul>
<li>Using a build tool, like Gradle</li>
<li>Wrap 3rd party interfaces using an Adaptor class</li>
<li>Only write tests that give you confidence</li>
<li>Invest in really understanding the CI runtime</li>
</ul>
</li>
</ul>
<hr />
<p>Created on 2022-05-28</p>
<p>Updated on 2023-03-09</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.expand"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>